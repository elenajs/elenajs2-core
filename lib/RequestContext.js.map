{"version":3,"sources":["RequestContext.js"],"names":[],"mappings":"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","file":"RequestContext.js","sourcesContent":["\"use strict\";\n\nlet dfs = require('./utils/dfs.js'),\n    url = require('url'),\n    IncomingForm = require('formidable').IncomingForm,\n    File = require('formidable').File;\n\n\n/**\n * RequestContext\n */\nclass RequestContext extends IncomingForm {\n    toString() {\n        let name = 'RequestContext';\n        return `[object ${name}]`;\n    }\n\n    constructor(request, response) {\n        super();\n        this._request = request;\n        this._response = response;\n        this._requestData = {};\n\n        let requestData = this._requestData;\n\n        function addFieldValue(name, value) {\n            if (requestData[name] === undefined) {\n                requestData[name] = value;\n            } else {\n                requestData[name] = [].concat(requestData[name], value);\n            }\n        }\n\n        this.on('field', function (name, value) {\n            addFieldValue(name, value);\n        });\n        this.on('file', function (name, value) {\n            addFieldValue(name, value);\n        });\n\n        this.on('aborted', function (err) {\n            this.reject && this.reject(err);\n            this.cleanupFormData();\n        });\n        this.on('error', function (err) {\n            this.reject && this.reject(err);\n            this.cleanupFormData();\n        });\n        this.on('end', function () {\n            this.resolve && this.resolve(requestData)\n        }.bind(this));\n        response.once('finish', function () {\n            this.cleanupFormData()\n        }.bind(this));\n    }\n\n    get request() {\n        return this._request;\n    }\n\n    get requestData() {\n        return this._requestData;\n    }\n\n    get response() {\n        return this._response;\n    }\n\n    get resolve() {\n        return this._resolve;\n    }\n\n    get reject() {\n        return this._reject;\n    }\n\n    _deleteTmpFile(path) {\n        dfs.unlink(path).chatch(function (err) {\n            this.emit('error', err);\n        }.bind(this));\n    }\n\n    handleResponse() {\n        return new Promise(function (resolve, reject) {\n            this._resolve = resolve;\n            this._reject = reject;\n            this.parse(this.request);\n        }.bind(this));\n    }\n\n    cleanupFormData() {\n        let req = this.request;\n        if (req.method.search(/^post$|^put$/i) === 0) {\n            let File = formidable.File,\n                requestData = req.requestData,\n                value;\n\n            for (let key in requestData) {\n                value = [].concat(requestData[key]);\n                value.forEach(function (item) {\n                    if (item instanceof File) {\n                        this._deleteTmpFile(item.path);\n                    }\n                }.bind(this));\n                delete  requestData[key];\n            }\n\n        }\n    }\n}\n\nmodule.exports = RequestContext;"],"sourceRoot":"../src"}